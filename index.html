<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Gerenciamento de Joias - PrimeGems</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

<!-- Firebase SDK (v12.5.0) -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD4O3WY5gN83r4fmQOa86p8OIOseRS7OQo",
        authDomain: "form-joia.firebaseapp.com",
        projectId: "form-joia",
        storageBucket: "form-joia.firebasestorage.app",
        messagingSenderId: "146556614859",
        appId: "1:146556614859:web:64a96439e441d5fdac834e",
        measurementId: "G-EN711RTQC8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Login anônimo
    signInAnonymously(auth).catch(() => {});

    // Exportar para uso global
    window.db = db;
    window.collection = collection;
    window.addDoc = addDoc;
    window.getDocs = getDocs;
    window.updateDoc = updateDoc;
    window.deleteDoc = deleteDoc;
    window.doc = doc;
    window.onSnapshot = onSnapshot;

    // Fallback IndexedDB
    window.useIndexedDB = false;
</script>

<style>
body{font-family:'Inter',sans-serif;background:#f2f2f2;margin:0;display:flex;justify-content:center;align-items:center;min-height:100vh;padding:20px;}
.container{background:#fff;padding:40px;border-radius:14px;width:100%;max-width:1000px;box-shadow:0 5px 18px rgba(0,0,0,0.12);}
#form-page, #details-page{max-width:700px;margin:0 auto;}
form{display:flex;flex-direction:column;gap:24px;}
label{font-weight:600;font-size:14px;margin-bottom:6px;display:block;}
input,textarea,select{width:100%;padding:10px 14px;font-size:14px;border:1px solid #cfcfcf;border-radius:10px;background:#fafafa;transition:0.2s;box-sizing:border-box;}
input:focus,textarea:focus,select:focus{outline:none;border-color:#03add4;background:#fff;box-shadow:0 0 6px rgba(3,173,212,0.25);}
.row{display:grid;gap:48px;grid-template-columns:repeat(2,1fr);}
.input-group{position:relative;}
.input-unit{position:absolute;top:50%;transform:translateY(-50%);color:#6c757d;font-size:14px;font-weight:600;pointer-events:none;z-index:1;}
input[name="peso"]{padding-right:35px;}
.input-group[data-unit-position="right"] .input-unit{right:14px;}
input#valor {padding-left: 40px;}
.input-group[data-unit-position="left"] .input-unit{left:14px;}
input#cpf {font-family: monospace;}
@media(max-width:768px){.row{grid-template-columns:1fr;gap:24px;}.container{padding:20px;}}
button{padding:14px;border:none;background:#03add4;color:#fff;font-weight:600;border-radius:10px;cursor:pointer;font-size:16px;transition:0.2s;box-shadow:0 4px 8px rgba(3,173,212,0.3);width:100%;}
button:hover{background:#0289a8;}
.header-main-page{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:15px;}
.filter-group{display:flex;gap:10px;align-items:center;max-width:500px;flex-grow:1;flex-wrap:wrap;}
.filter-group input{border-radius:10px;border:1px solid #cfcfcf;padding:10px 14px;}
.filter-group input[type="date"]{width:160px;}
.btn-new-registration{width:auto;padding:10px 20px;font-size:14px;}
.jewel-table-container{overflow-x:auto;margin-top:20px;}
.jewel-table{width:100%;border-collapse:collapse;font-size:14px;}
.jewel-table th,.jewel-table td{text-align:left;padding:12px 15px;border-bottom:1px solid #eee;}
.jewel-table th{background:#03add4;color:#fff;font-weight:700;text-transform:uppercase;}
.jewel-table tbody tr:hover{background:#f7f7f7;}
.action-buttons button{background:none;border:none;padding:5px;cursor:pointer;font-size:16px;margin:0 4px;width:auto;box-shadow:none;}
.action-view{color:#28a745;}
.action-edit{color:#ffc107;}
.action-delete{color:#dc3545;}
.action-download{color:#007bff;}
.btn-back{background:#e5e5e5;color:#000;font-size:12px;padding:6px 12px;border-radius:6px;display:inline-flex;align-items:center;gap:6px;box-shadow:none;margin-bottom:16px;width:auto;}
.btn-back:hover{background:#d0d0d0;}
#details-page h2{margin-top: 0; color: #03add4;}
#details-content{display: grid;grid-template-columns: repeat(2, 1fr);gap: 20px;margin-top: 20px;padding: 20px;border: 1px solid #ddd;border-radius: 10px;background: #fdfdfd;}
.detail-item {padding: 8px 0;border-bottom: 1px dotted #eee;}
.detail-item strong{color: #4a4a4a;font-weight: 600;display: flex;align-items: center;gap: 8px;margin-bottom: 4px;}
.detail-value {font-size: 15px;color: #333;}
.detail-description, .detail-image-full {grid-column: 1 / -1;}
.detail-image-full img {max-width: 100%;height: auto;border-radius: 10px;box-shadow: 0 2px 8px rgba(0,0,0,0.1);margin-top: 10px;}
@media(max-width: 600px) {#details-content {grid-template-columns: 1fr;}}
#loading-message {text-align:center;padding:20px;color:#03add4;font-style:italic;}
#loading-message p {color: red;margin: 10px 0;}
</style>
</head>

<body>

<script>
// Senha: Prime123
const PASSWORD_HASH = "a05e4e1cb70f5f11a047c7548957565111658d7602593eace8879cf16d60f5ef";

function checkPassword() {
    const userPass = prompt("Digite a senha de acesso:");
    if (!userPass) return window.location.href = "https://www.google.com";
    const hash = CryptoJS.SHA256(userPass).toString();
    if (hash !== PASSWORD_HASH) {
        alert("Senha incorreta!");
        window.location.href = "https://www.google.com";
    }
}
checkPassword();
</script>

<div class="container">
    <!-- LOGO NO TOPO DA PÁGINA -->
    <div id="app-header" style="text-align:center; margin-bottom: 20px; display:none;">
        <img id="logo-top" src="" alt="PrimeGems Logo" style="height: 50px; max-width: 100%; object-fit: contain;">
        <div id="wave-separator" style="height: 12px; margin: 8px auto 0; width: 80%; background: linear-gradient(to right, transparent, #03ADD4, transparent); background-size: 100% 100%;"></div>
    </div>

    <div id="loading-message">Carregando banco de dados...</div>

    <!-- Página Principal -->
    <div id="main-page" style="display:none;">
        <div class="header-main-page">
            <div class="filter-group">
                <label for="filter-search" style="margin-bottom:0;white-space:nowrap;">Buscar:</label>
                <input type="text" id="filter-search" placeholder="Cliente, CPF, tipo ou material" oninput="filterJewels()" />
                <input type="date" id="filter-date" onchange="filterJewels()" />
            </div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;">
                <button class="btn-new-registration" onclick="switchPage('form-page')"><i class="fas fa-plus-circle"></i> Novo Cadastro</button>
                <button class="btn-new-registration" onclick="downloadAllPDF()"><i class="fas fa-file-download"></i> Baixar Lista</button>
                <button class="btn-new-registration" onclick="exportData()"><i class="fas fa-download"></i> Backup</button>
                <button class="btn-new-registration" onclick="importData()" style="background:#28a745;"><i class="fas fa-upload"></i> Restaurar</button>
            </div>
        </div>

        <div class="jewel-table-container">
            <table class="jewel-table">
                <thead>
                    <tr>
                        <th>Cliente</th><th>CPF</th><th>Tipo</th><th>Material</th><th>Valor</th><th>Data</th><th>Ações</th>
                    </tr>
                </thead>
                <tbody id="jewel-list"></tbody>
            </table>
        </div>
        <div id="empty-message" style="text-align:center;padding:30px;color:#6c757d;font-style:italic;display:none;">Nenhum cadastro</div>
    </div>

    <!-- Detalhes -->
    <div id="details-page" style="display:none;">
        <button class="btn-back" onclick="switchPage('main-page')"><i class="fas fa-arrow-left"></i> Voltar</button>
        <h2>Detalhes da Joia</h2>
        <div id="details-content"></div> 
    </div>

    <!-- Formulário de Cadastro -->
    <div id="form-page" style="display:none;">
        <button class="btn-back" onclick="switchPage('main-page')"><i class="fas fa-arrow-left"></i> Voltar</button>
        <form id="jewel-form" onsubmit="handleFormSubmit(event)">
            <div><label>Cliente</label><input id="cliente" required></div>
            <div>
                <label>CPF</label>
                <input id="cpf" placeholder="000.000.000-00" oninput="formatCPF(this)" maxlength="14" required>
            </div>
            <div>
                <label>Endereço</label>
                <input id="endereco" placeholder="Rua, número, bairro, cidade - PI" required>
            </div>
            <div><label>Descrição</label><textarea id="descricao" rows="4"></textarea></div>
            <div class="row">
                <div><label>Tipo</label><input id="tipo"></div>
                <div><label>Material</label><input id="material"></div>
            </div>
            <div class="row">
                <div>
                    <label>Peso</label>
                    <div class="input-group" data-unit-position="right">
                        <input id="peso" oninput="formatInput(this,2)"><span class="input-unit">g</span>
                    </div>
                </div>
                <div>
                    <label>Valor</label>
                    <div class="input-group" data-unit-position="left">
                        <span class="input-unit">R$</span><input id="valor" oninput="formatInput(this,2)">
                    </div>
                </div>
            </div>
            <div><label>Data</label><input type="date" id="data"></div>
            <div>
                <label>Imagem da Joia</label>
                <input type="file" id="imagem" accept="image/*" onchange="previewImage(event)">
                <img id="image-preview" src="" style="width: 100%; max-width: 250px; margin-top: 15px; border-radius: 8px; display: none; object-fit: cover;">
            </div>
            <button type="submit">Salvar</button>
        </form>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script type="module">
// === LOGO EM BASE64 (COLE AQUI SUA LOGO) ===
const LOGO_BASE64 = ""

// === CARREGAR LOGO NO TOPO DA PÁGINA ===
function loadLogoOnPage() {
    if (LOGO_BASE64) {
        const logoImg = document.getElementById('logo-top');
        logoImg.src = `data:image/png;base64,${LOGO_BASE64}`;
        document.getElementById('app-header').style.display = 'block';
    }
}

// === IndexedDB (FALLBACK) ===
let indexedDBInstance;
const DB_NAME = 'primegems';
const DB_VERSION = 1;
const STORE_NAME = 'jewels';

function openDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onerror = () => reject(request.error);
        request.onsuccess = () => { indexedDBInstance = request.result; resolve(); };
        request.onupgradeneeded = (e) => {
            indexedDBInstance = e.target.result;
            if (!indexedDBInstance.objectStoreNames.contains(STORE_NAME)) {
                indexedDBInstance.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
            }
        };
    });
}

async function getAllJewels() {
    if (window.useIndexedDB) {
        return new Promise((resolve, reject) => {
            const tx = indexedDBInstance.transaction(STORE_NAME, 'readonly');
            const store = tx.objectStore(STORE_NAME);
            const request = store.getAll();
            request.onsuccess = () => resolve(request.result || []);
            request.onerror = () => reject(request.error);
        });
    } else {
        const snapshot = await getDocs(collection(db, "jewels"));
        return snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    }
}

async function addJewel(jewel) {
    if (window.useIndexedDB) {
        return new Promise((resolve, reject) => {
            const tx = indexedDBInstance.transaction(STORE_NAME, 'readwrite');
            const store = tx.objectStore(STORE_NAME);
            const request = store.add(jewel);
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    } else {
        const docRef = await addDoc(collection(db, "jewels"), jewel);
        return docRef.id;
    }
}

async function updateJewel(jewel) {
    if (window.useIndexedDB) {
        return new Promise((resolve, reject) => {
            const tx = indexedDBInstance.transaction(STORE_NAME, 'readwrite');
            const store = tx.objectStore(STORE_NAME);
            const request = store.put(jewel);
            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
        });
    } else {
        await updateDoc(doc(db, "jewels", jewel.id), jewel);
    }
}

async function deleteJewel(id) {
    if (window.useIndexedDB) {
        return new Promise((resolve, reject) => {
            const tx = indexedDBInstance.transaction(STORE_NAME, 'readwrite');
            const store = tx.objectStore(STORE_NAME);
            const request = store.delete(id);
            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
        });
    } else {
        await deleteDoc(doc(db, "jewels", id));
    }
}

// === App ===
let jewels = [];

async function loadJewels() {
    try {
        jewels = await getAllJewels();
        filterJewels();
    } catch (error) {
        console.warn("Firebase falhou, usando IndexedDB...", error);
        window.useIndexedDB = true;
        await openDB();
        jewels = await getAllJewels();
        filterJewels();
    }
}

function formatDateBR(d){ if(!d) return''; const[y,m,day]=d.split('-'); return`${day}/${m}/${y}`; }
function formatDateExtenso(d) {
    const meses = ['janeiro','fevereiro','março','abril','maio','junho','julho','agosto','setembro','outubro','novembro','dezembro'];
    const [y, m, day] = d.split('-');
    return `${parseInt(day)} de ${meses[parseInt(m)-1]} de ${y}`;
}

function formatCPF(input) {
    let v = input.value.replace(/\D/g, '');
    v = v.replace(/(\d{3})(\d)/, '$1.$2');
    v = v.replace(/(\d{3})(\d)/, '$1.$2');
    v = v.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
    input.value = v;
}

function previewImage(event) {
    const reader = new FileReader();
    const output = document.getElementById('image-preview');
    reader.onload = () => { output.src = reader.result; output.style.display = 'block'; };
    if (event.target.files[0]) reader.readAsDataURL(event.target.files[0]);
    else { output.src = ""; output.style.display = 'none'; }
}

function filterJewels() {
    const text = document.getElementById('filter-search').value.toLowerCase();
    const date = document.getElementById('filter-date').value;
    const filtered = jewels.filter(j => {
        const matchesText = j.cliente.toLowerCase().includes(text) ||
                           j.cpf.toLowerCase().includes(text) ||
                           j.tipo.toLowerCase().includes(text) ||
                           j.material.toLowerCase().includes(text);
        const matchesDate = !date || j.data === date;
        return matchesText && matchesDate;
    });
    renderJewelsFiltered(filtered);
}

function renderJewelsFiltered(filtered) {
    const tbody = document.getElementById('jewel-list');
    const empty = document.getElementById('empty-message');
    const table = document.querySelector('.jewel-table-container');
    tbody.innerHTML = '';
    if (filtered.length === 0) {
        empty.style.display = 'block';
        table.style.display = 'none';
        empty.innerHTML = jewels.length > 0 ? 'Nenhum item encontrado' : 'Nenhum cadastro';
        return;
    }
    empty.style.display = 'none';
    table.style.display = 'block';
    filtered.forEach(j => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${j.cliente}</td>
            <td>${j.cpf}</td>
            <td>${j.tipo}</td>
            <td>${j.material}</td>
            <td>${j.valorFormatado}</td>
            <td>${formatDateBR(j.data)}</td>
            <td class="action-buttons">
                <button class="action-view" onclick="viewJewel('${j.id}')"><i class="fas fa-eye"></i></button>
                <button class="action-edit" onclick="editJewel('${j.id}')"><i class="fas fa-edit"></i></button>
                <button class="action-delete" onclick="deleteJewelDB('${j.id}')"><i class="fas fa-trash"></i></button>
                <button class="action-download" onclick="downloadContrato('${j.id}')"><i class="fas fa-file-contract"></i></button>
            </td>`;
    });
}

function viewJewel(id){
    const j = jewels.find(x => x.id === id);
    const imageHtml = j.imagem ? `<div class="detail-item detail-image-full"><img src="${j.imagem}"></div>` : '';
    const descriptionHtml = j.descricao ? `<div class="detail-item detail-description"><strong><i class="fas fa-file-alt"></i> Descrição</strong><div class="detail-value">${j.descricao}</div></div>` : '';
    document.getElementById('details-content').innerHTML = `
    <div class="detail-item"><strong><i class="fas fa-user-tag"></i> Cliente</strong><div class="detail-value">${j.cliente}</div></div>
    <div class="detail-item"><strong><i class="fas fa-id-card"></i> CPF</strong><div class="detail-value">${j.cpf}</div></div>
    <div class="detail-item"><strong><i class="fas fa-home"></i> Endereço</strong><div class="detail-value">${j.endereco}</div></div>
    <div class="detail-item"><strong><i class="fas fa-gem"></i> Tipo</strong><div class="detail-value">${j.tipo}</div></div>
    <div class="detail-item"><strong><i class="fas fa-ring"></i> Material</strong><div class="detail-value">${j.material}</div></div>
    <div class="detail-item"><strong><i class="fas fa-weight-hanging"></i> Peso</strong><div class="detail-value">${j.pesoFormatado}</div></div>
    <div class="detail-item"><strong><i class="fas fa-dollar-sign"></i> Valor</strong><div class="detail-value">${j.valorFormatado}</div></div>
    <div class="detail-item"><strong><i class="fas fa-calendar-alt"></i> Data</strong><div class="detail-value">${formatDateBR(j.data)}</div></div>
    ${descriptionHtml}${imageHtml}`;
    switchPage('details-page');
}

async function editJewel(id){
    const j = jewels.find(x => x.id === id);
    document.getElementById('cliente').value = j.cliente;
    document.getElementById('cpf').value = j.cpf;
    document.getElementById('endereco').value = j.endereco;
    document.getElementById('descricao').value = j.descricao;
    document.getElementById('tipo').value = j.tipo;
    document.getElementById('material').value = j.material;
    document.getElementById('peso').value = j.pesoFormatado.replace(' g','');
    document.getElementById('valor').value = j.valorFormatado.replace('R$ ','');
    document.getElementById('data').value = j.data;
    const img = document.getElementById('image-preview');
    if (j.imagem) { img.src = j.imagem; img.style.display = 'block'; } 
    else { img.src = ""; img.style.display = 'none'; }
    document.getElementById('imagem').value = null;
    document.getElementById('jewel-form').dataset.editing = id;
    switchPage('form-page');
}

async function deleteJewelDB(id){
    if (!confirm('Excluir este registro?')) return;
    await deleteJewel(id);
    await loadJewels();
}

// === CONTRATO EM 1 PÁGINA ===
function downloadContrato(id) {
    const j = jewels.find(x => x.id === id);
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const margin = 14;
    const contentWidth = pageWidth - 2 * margin;
    let y = 10;

    if (LOGO_BASE64) {
        const img = new Image();
        img.onload = function () {
            const maxHeight = 24;
            const ratio = this.width / this.height;
            const h = maxHeight;
            const w = h * ratio;
            doc.addImage(LOGO_BASE64, 'PNG', margin, y, w, h);
            y += h + 4;
            drawWave();
        };
        img.onerror = () => drawWave();
        img.src = `data:image/png;base64,${LOGO_BASE64}`;
    } else {
        drawWave();
    }

    function drawWave() {
        const waveY = y;
        doc.setDrawColor(3, 173, 212);
        doc.setLineWidth(2.5);
        let prevX = margin, prevY = waveY + 6;
        for (let i = 1; i <= 300; i++) {
            const x = margin + (i / 300) * contentWidth;
            const yPos = waveY + 6 + Math.sin(i / 300 * Math.PI * 4) * 3;
            doc.line(prevX, prevY, x, yPos);
            prevX = x;
            prevY = yPos;
        }
        y = waveY + 16;
        continuePDF();
    }

    function continuePDF() {
        doc.setFont("helvetica", "bold");
        doc.setFontSize(14);
        doc.text("FORMULÁRIO DE REGISTRO DE JOIA", pageWidth / 2, y, { align: "center" });
        y += 12;
        doc.setFont("helvetica", "normal");
        doc.setFontSize(9.5);
        const dados = [
            `Cliente: ${j.cliente}`,
            `CPF: ${j.cpf}`,
            `Endereço: ${j.endereco}`,
            `Data: ${formatDateExtenso(j.data)}`
        ];
        dados.forEach(line => { doc.text(line, margin, y); y += 4.6; });
        y += 6;
        doc.setFontSize(8.8);
        const paragrafos = [
            `Eu, ${j.cliente}, portador(a) do CPF ${j.cpf}, residente à ${j.endereco}, declaro, sob minha total responsabilidade, que sou o(a) proprietário(a) das joias negociadas, conforme detalhado nesta nota.`,
            ``,
            `Além disso, afirmo que possuo plenos direitos para a venda das referidas joias, garantindo que as mesmas não estão sujeitas a disputas legais, ônus ou quaisquer outras restrições que possam comprometer sua propriedade ou transferência.`,
            ``,
            `Declaro também que todas as informações fornecidas para a minha identificação são verdadeiras e legítimas, ciente das implicações legais em caso de falsidade. Assumo total responsabilidade, tanto no âmbito civil quanto criminal, pelas informações apresentadas neste termo, reconhecendo que eventuais incoerências ou falsidades poderão resultar em sanções previstas em lei.`
        ];
        paragrafos.forEach(par => {
            if (par === "") { y += 4; return; }
            const lines = doc.splitTextToSize(par, contentWidth);
            doc.text(lines, margin, y);
            y += lines.length * 4.2;
        });
        y += 6;
        doc.setFont("helvetica", "bold");
        doc.setFontSize(10.5);
        doc.text("AVALIAÇÃO", margin, y);
        y += 6;
        doc.setFont("helvetica", "normal");
        doc.setFontSize(9);
        const tabela = [
            ["Descrição", j.descricao || "—"],
            ["Tipo", j.tipo],
            ["Material", j.material],
            ["Peso", j.pesoFormatado],
            ["Valor", j.valorFormatado]
        ];
        tabela.forEach(([label, valor]) => { doc.text(`${label}: ${valor}`, margin + 3, y); y += 4.6; });
        y += 6;
        doc.setFontSize(8.8);
        const fraseFinal = `Por fim, declaro a transferência integral dos direitos, posse e uso dos bens descritos na referida nota para a Prime Gems LTDA.`;
        doc.text(doc.splitTextToSize(fraseFinal, contentWidth), margin, y);
        y += 20;
        doc.setFontSize(8.5);
        doc.text("Assinatura cliente: ______________________________________", margin, y);
        doc.text("Assinatura do Responsável: ______________________________________", margin, y + 7);

        if (j.imagem) {
            const img = new Image();
            img.onload = function() {
                let w = this.width, h = this.height;
                if (w > 68) { h = (68 * h) / w; w = 68; }
                if (h > 52) { w = (52 * w) / h; h = 52; }
                const x = (pageWidth - w) / 2;
                doc.addImage(j.imagem, 'JPEG', x, pageHeight - h - 14, w, h);
                doc.save(`contrato_${id}.pdf`);
            };
            img.src = j.imagem;
        } else {
            doc.save(`contrato_${id}.pdf`);
        }
    }
}

function downloadAllPDF() {
    if (jewels.length === 0) return alert("Nenhum registro para exportar.");
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(18);
    doc.text("Lista de Joias", 105, 20, { align: "center" });
    let y = 30;
    jewels.forEach(jewel => {
        if (y > 270) { doc.addPage(); y = 20; }
        doc.setFontSize(10);
        doc.text(`${jewel.cliente} | ${jewel.cpf} | ${jewel.tipo} | R$ ${jewel.valorFormatado}`, 10, y);
        y += 7;
    });
    doc.save("lista_joias.pdf");
}

async function exportData() {
    await loadJewels();
    const dataStr = JSON.stringify(jewels, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    const exportFileDefaultName = `backup_${new Date().toISOString().slice(0,10)}.json`;
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
}

function importData() {
    const input = document.createElement('input');
    input.type = 'file'; input.accept = '.json';
    input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const text = await file.text();
        try {
            const data = JSON.parse(text);
            if (!Array.isArray(data)) throw new Error("Arquivo inválido.");
            if (window.useIndexedDB) {
                const tx = indexedDBInstance.transaction(STORE_NAME, 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                await store.clear();
                for (const j of data) await store.add(j);
                await new Promise(r => tx.oncomplete = r);
            } else {
                for (const j of data) await addDoc(collection(db, "jewels"), j);
            }
            await loadJewels();
            alert("Dados restaurados com sucesso!");
        } catch (err) {
            alert("Erro ao importar: " + err.message);
        }
    };
    input.click();
}

async function handleFormSubmit(e) {
    e.preventDefault();
    const form = e.target;
    const editingId = form.dataset.editing;
    const clean = n => n.replace(/[R$\s\.]/g,'').replace(',','.');

    const cpf = document.getElementById('cpf').value.replace(/\D/g, '');
    if (cpf.length !== 11) {
        alert("CPF deve ter 11 dígitos.");
        return;
    }

    const jewel = {
        cliente: document.getElementById('cliente').value.trim(),
        cpf: document.getElementById('cpf').value,
        endereco: document.getElementById('endereco').value.trim(),
        descricao: document.getElementById('descricao').value.trim(),
        tipo: document.getElementById('tipo').value.trim(),
        material: document.getElementById('material').value.trim(),
        peso: clean(document.getElementById('peso').value),
        pesoFormatado: document.getElementById('peso').value + ' g',
        valor: clean(document.getElementById('valor').value),
        valorFormatado: 'R$ ' + document.getElementById('valor').value,
        data: document.getElementById('data').value,
        imagem: ''
    };

    const imageFile = document.getElementById('imagem').files[0];

    const saveOrUpdate = async (base64) => {
        jewel.imagem = base64 || '';
        try {
            if (editingId) {
                jewel.id = editingId;
                const old = jewels.find(j => j.id === editingId);
                if (!imageFile && old?.imagem) jewel.imagem = old.imagem;
                await updateJewel(jewel);
            } else {
                const newId = await addJewel(jewel);
                jewel.id = newId;
            }
            await loadJewels();
            form.reset();
            document.getElementById('image-preview').style.display = 'none';
            delete form.dataset.editing;
            switchPage('main-page');
        } catch (err) {
            alert("Erro ao salvar: " + err.message);
        }
    };

    if (imageFile) {
        const reader = new FileReader();
        reader.onload = e => saveOrUpdate(e.target.result);
        reader.readAsDataURL(imageFile);
    } else {
        saveOrUpdate();
    }
}

function formatInput(input, p){
    const start = input.selectionStart, old = input.value.length;
    let v = input.value.replace(/\D/g,'');
    if(!v){ input.value=''; return; }
    const n = parseFloat(v)/Math.pow(10,p);
    const f = n.toLocaleString('pt-BR',{minimumFractionDigits:p,maximumFractionDigits:p});
    input.value = f;
    const d = input.value.length - old;
    input.setSelectionRange(start+d, start+d);
}

// === FUNÇÃO switchPage FORA DO MODULE (CORRIGIDA) ===
function switchPage(p){
    ['main-page','form-page','details-page'].forEach(id => {
        document.getElementById(id).style.display = 'none';
    });
    document.getElementById(p).style.display = 'block';
    if (p === 'main-page') filterJewels();
}

// === INICIALIZAÇÃO ===
(async () => {
    const loadingMessage = document.getElementById('loading-message');

    try {
        onSnapshot(collection(db, "jewels"), () => loadJewels());
        await loadJewels();
    } catch (err) {
        console.warn("Firebase indisponível, usando IndexedDB...", err);
        window.useIndexedDB = true;
        await openDB();
        await loadJewels();
    }

    loadingMessage.remove();
    document.getElementById('main-page').style.display = 'block';
    loadLogoOnPage();
})();
</script>
</body>
</html>