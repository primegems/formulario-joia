<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Gerenciamento de Joias</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
body{font-family:'Inter',sans-serif;background:#f2f2f2;margin:0;display:flex;justify-content:center;align-items:center;min-height:100vh;padding:20px;}
.container{background:#fff;padding:40px;border-radius:14px;width:100%;max-width:1000px;box-shadow:0 5px 18px rgba(0,0,0,0.12);}
.logo{text-align:center;margin-bottom:32px;}
.logo img{height:60px;margin:0 auto 12px auto;display:block;}
#form-page{max-width:700px;margin:0 auto;}
form{display:flex;flex-direction:column;gap:24px;}
label{font-weight:600;font-size:14px;margin-bottom:6px;display:block;}
input,textarea{width:100%;padding:10px 14px;font-size:14px;border:1px solid #cfcfcf;border-radius:10px;background:#fafafa;transition:0.2s;box-sizing:border-box;}
input:focus,textarea:focus{outline:none;border-color:#03add4;background:#fff;box-shadow:0 0 6px rgba(3,173,212,0.25);}
.row{display:grid;gap:48px;grid-template-columns:repeat(2,1fr);}
.input-group{position:relative;}
.input-unit{position:absolute;top:50%;transform:translateY(-50%);color:#6c757d;font-size:14px;font-weight:600;pointer-events:none;z-index:1;}
input[name="peso"]{padding-right:35px;}
.input-group[data-unit-position="right"] .input-unit{right:14px;}
input#valor {padding-left: 40px;}
.input-group[data-unit-position="left"] .input-unit{left:14px;}
@media(max-width:768px){.row{grid-template-columns:1fr;gap:24px;}.container{padding:20px;}}
button{padding:14px;border:none;background:#03add4;color:#fff;font-weight:600;border-radius:10px;cursor:pointer;font-size:16px;transition:0.2s;box-shadow:0 4px 8px rgba(3,173,212,0.3);width:100%;}
button:hover{background:#0289a8;}
.header-main-page{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:15px;}
.filter-group{display:flex;gap:10px;align-items:center;max-width:300px;flex-grow:1;}
.filter-group input{border-radius:10px;border:1px solid #cfcfcf;padding:10px 14px;}
.btn-new-registration{width:auto;padding:10px 20px;}
.jewel-table-container{overflow-x:auto;margin-top:20px;}
.jewel-table{width:100%;border-collapse:collapse;font-size:14px;}
.jewel-table th,.jewel-table td{text-align:left;padding:12px 15px;border-bottom:1px solid #eee;}
.jewel-table th{background:#03add4;color:#fff;font-weight:700;text-transform:uppercase;}
.jewel-table tbody tr:hover{background:#f7f7f7;}
.action-buttons button{background:none;border:none;padding:5px;cursor:pointer;font-size:16px;margin:0 4px;width:auto;box-shadow:none;}
.action-view{color:#28a745;}
.action-edit{color:#ffc107;}
.action-delete{color:#dc3545;}
.action-download{color:#007bff;}
.btn-back{background:#e5e5e5;color:#000;font-size:12px;padding:6px 12px;border-radius:6px;display:inline-flex;align-items:center;gap:6px;box-shadow:none;margin-bottom:16px;width:auto;}
.btn-back:hover{background:#d0d0d0;}

/* NOVOS ESTILOS PARA VISUALIZAÇÃO (DETAILS) */
#details-page h2{margin-top: 0; color: #03add4;}
#details-content{
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    margin-top: 20px;
    padding: 20px;
    border: 1px solid #ddd;
    border-radius: 10px;
    background: #fdfdfd;
}
.detail-item {padding: 8px 0;border-bottom: 1px dotted #eee;}
.detail-item strong{color: #4a4a4a;font-weight: 600;display: flex;align-items: center;gap: 8px;margin-bottom: 4px;}
.detail-value {font-size: 15px;color: #333;}
.detail-description, .detail-image-full {grid-column: 1 / -1;}
.detail-image-full img {max-width: 100%; height: auto; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-top: 10px;}
@media(max-width: 600px) {#details-content {grid-template-columns: 1fr;}}
</style>
</head>

<body>
<div class="container">
<div id="main-page">
<div class="header-main-page">
<div class="filter-group">
<label for="filter-search" style="margin-bottom:0;">Filtrar:</label>
<input type="text" id="filter-search" placeholder="Buscar" oninput="filterJewels(this.value)" />
</div>
<div style="display:flex;gap:10px;">
<button class="btn-new-registration" onclick="switchPage('form-page')"><i class="fas fa-plus-circle"></i> Novo Cadastro</button>
<button class="btn-new-registration" onclick="downloadAllPDF()"><i class="fas fa-file-download"></i> Baixar Lista</button>
</div>
</div>

<div class="jewel-table-container">
<table class="jewel-table">
<thead>
<tr>
<th>Cliente</th><th>Tipo</th><th>Material</th><th>Valor</th><th>Data</th><th>Ações</th>
</tr>
</thead>
<tbody id="jewel-list"></tbody>
</table>
</div>
<div id="empty-message" style="text-align:center;padding:30px;color:#6c757d;font-style:italic;display:none;">Nenhum cadastro</div>
</div>

<div id="details-page" style="display:none;">
<button class="btn-back" onclick="switchPage('main-page')"><i class="fas fa-arrow-left"></i> Voltar</button>
<h2>Detalhes da Joia</h2>
<div id="details-content"></div> 
</div>

<div id="form-page" style="display:none;">
<button class="btn-back" onclick="switchPage('main-page')"><i class="fas fa-arrow-left"></i> Voltar</button>
<form id="jewel-form" onsubmit="handleFormSubmit(event)">
<div><label>Cliente</label><input id="cliente" required></div>
<div><label>Descrição</label><textarea id="descricao" rows="4"></textarea></div>
<div class="row">
<div><label>Tipo</label><input id="tipo"></div>
<div><label>Material</label><input id="material"></div>
</div>
<div class="row">
<div>
<label>Peso</label>
<div class="input-group" data-unit-position="right">
<input id="peso" oninput="formatInput(this,2)"><span class="input-unit">g</span>
</div>
</div>
<div>
<label>Valor</label>
<div class="input-group" data-unit-position="left">
<span class="input-unit">R$</span><input id="valor" oninput="formatInput(this,2)">
</div>
</div>
</div>
<div><label>Data</label><input type="date" id="data"></div>

<div>
<label>Imagem da Joia</label>
<input type="file" id="imagem" accept="image/*" onchange="previewImage(event)">
<img id="image-preview" src="" style="width: 100%; max-width: 250px; margin-top: 15px; border-radius: 8px; display: none; object-fit: cover;">
</div>
<button type="submit">Salvar</button>
</form>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyCap5dlkL_SMC0U19SqfOpta6m3GWuAIP4",
  authDomain: "formulario-joia.firebaseapp.com",
  projectId: "formulario-joia",
  storageBucket: "formulario-joia.appspot.com",
  messagingSenderId: "134389901655",
  appId: "1:134389901655:web:2f50d545c0c38ba2f47612",
  measurementId: "G-EXDP1JY52X"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore();
const storage = getStorage();

let jewels = [];

// Carrega registros do Firestore
async function loadJewels() {
  const querySnapshot = await getDocs(collection(db, "jewels"));
  jewels = [];
  querySnapshot.forEach(docSnap => {
    jewels.push({id: docSnap.id, ...docSnap.data()});
  });
  renderJewels();
}

// Salva imagem no Storage e retorna URL
async function uploadImage(file) {
  if (!file) return '';
  const storageRef = ref(storage, 'images/' + Date.now() + '_' + file.name);
  await uploadBytes(storageRef, file);
  const url = await getDownloadURL(storageRef);
  return url;
}

// Renderiza tabela
function renderJewels(filterText='') {
  const tbody=document.getElementById('jewel-list');
  const empty=document.getElementById('empty-message');
  const table=document.querySelector('.jewel-table-container');
  tbody.innerHTML='';
  const f=filterText.toLowerCase();
  const filtered=jewels.filter(j=> j.cliente.toLowerCase().includes(f)||j.tipo.toLowerCase().includes(f)||j.material.toLowerCase().includes(f));
  if(filtered.length===0){
    empty.style.display='block';table.style.display='none';
    empty.innerHTML=jewels.length>0&&filterText?'Nenhum item encontrado':'Nenhum cadastro';return;
  }
  empty.style.display='none';table.style.display='block';
  filtered.forEach(j=>{
    const row=tbody.insertRow();
    row.innerHTML=`
      <td>${j.cliente}</td>
      <td>${j.tipo}</td>
      <td>${j.material}</td>
      <td>${j.valor}</td>
      <td>${j.data}</td>
      <td class="action-buttons">
        <button class="action-view" onclick="viewJewel('${j.id}')"><i class="fas fa-eye"></i></button>
        <button class="action-edit" onclick="editJewel('${j.id}')"><i class="fas fa-edit"></i></button>
        <button class="action-delete" onclick="deleteJewel('${j.id}')"><i class="fas fa-trash"></i></button>
      </td>`;
  });
}

// Visualizar registro
function viewJewel(id) {
  const j = jewels.find(x=>x.id===id);
  const imageHtml = j.imagem ? `<div class="detail-item detail-image-full"><img src="${j.imagem}"></div>` : '';
  const descriptionHtml = j.descricao ? `<div class="detail-item detail-description"><strong><i class="fas fa-file-alt"></i> Descrição</strong><div class="detail-value">${j.descricao}</div></div>` : '';
  document.getElementById('details-content').innerHTML=`
    <div class="detail-item"><strong><i class="fas fa-user-tag"></i> Cliente</strong><div class="detail-value">${j.cliente}</div></div>
    <div class="detail-item"><strong><i class="fas fa-calendar-alt"></i> Data</strong><div class="detail-value">${j.data}</div></div>
    <div class="detail-item"><strong><i class="fas fa-gem"></i> Tipo</strong><div class="detail-value">${j.tipo}</div></div>
    <div class="detail-item"><strong><i class="fas fa-ring"></i> Material</strong><div class="detail-value">${j.material}</div></div>
    <div class="detail-item"><strong><i class="fas fa-weight-hanging"></i> Peso</strong><div class="detail-value">${j.peso}</div></div>
    <div class="detail-item"><strong><i class="fas fa-dollar-sign"></i> Valor</strong><div class="detail-value">${j.valor}</div></div>
    ${descriptionHtml}
    ${imageHtml}`;
  switchPage('details-page');
}

// Editar registro
function editJewel(id){
  const j=jewels.find(x=>x.id===id);
  document.getElementById('cliente').value = j.cliente;
  document.getElementById('descricao').value = j.descricao;
  document.getElementById('tipo').value = j.tipo;
  document.getElementById('material').value = j.material;
  document.getElementById('peso').value = j.peso;
  document.getElementById('valor').value = j.valor;
  document.getElementById('data').value = j.data;
  document.getElementById('image-preview').src = j.imagem || '';
  document.getElementById('image-preview').style.display = j.imagem ? 'block' : 'none';
  document.getElementById('jewel-form').dataset.editing = id;
  switchPage('form-page');
}

// Deletar registro
async function deleteJewel(id){
  if(!confirm('Excluir?')) return;
  await deleteDoc(doc(db, "jewels", id));
  await loadJewels();
}

// Envio do formulário
async function handleFormSubmit(e){
  e.preventDefault();
  const form = e.target;
  const editingId = form.dataset.editing;
  const file = document.getElementById('imagem').files[0];
  const imageUrl = await uploadImage(file);

  const jewel = {
    cliente: document.getElementById('cliente').value,
    descricao: document.getElementById('descricao').value,
    tipo: document.getElementById('tipo').value,
    material: document.getElementById('material').value,
    peso: document.getElementById('peso').value,
    valor: document.getElementById('valor').value,
    data: document.getElementById('data').value,
    imagem: imageUrl
  };

  if(editingId){
    await updateDoc(doc(db, "jewels", editingId), jewel);
    delete form.dataset.editing;
  } else {
    await addDoc(collection(db, "jewels"), jewel);
  }

  form.reset();
  document.getElementById('image-preview').style.display='none';
  await loadJewels();
  switchPage('main-page');
}

// Pré-visualização da imagem
function previewImage(event) {
  const reader = new FileReader();
  const output = document.getElementById('image-preview');
  reader.onload = function(){ output.src = reader.result; output.style.display='block'; };
  if (event.target.files[0]) reader.readAsDataURL(event.target.files[0]);
}

// Filtrar registros
function filterJewels(t){ renderJewels(t); }
function formatInput(input,p){ const start=input.selectionStart,old=input.value.length; let v=input.value.replace(/\D/g,''); if(!v){input.value='';return;} const n=parseFloat(v)/Math.pow(10,p); input.value=n.toLocaleString('pt-BR',{minimumFractionDigits:p,maximumFractionDigits:p}); const d=input.value.length-old; input.setSelectionRange(start+d,start+d); }
function switchPage(p){ document.getElementById('main-page').style.display='none'; document.getElementById('form-page').style.display='none'; document.getElementById('details-page').style.display='none'; document.getElementById(p).style.display='block'; if(p==='form-page'){ document.getElementById('image-preview').style.display='none'; document.getElementById('image-preview').src=''; document.getElementById('imagem').value=null; } }

document.addEventListener('DOMContentLoaded', ()=>{ loadJewels(); });
document.getElementById('jewel-form').addEventListener('submit', handleFormSubmit);

</script>
</body>
</html>
